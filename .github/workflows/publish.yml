name: Publish to npm

on:
  workflow_run:
    workflows: ['Zig-Cross-Compile']
    types: [completed]
    # æ„å»ºå®Œæˆåè‡ªåŠ¨è§¦å‘å‘å¸ƒ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘å‘å¸ƒ

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' }}
    # åªåœ¨æ ‡ç­¾æ¨é€è§¦å‘çš„æ„å»ºæˆåŠŸæ—¶å‘å¸ƒï¼ˆbuild.yml å·²é™åˆ¶åªæœ‰ v* æ ‡ç­¾è§¦å‘ï¼‰

    steps:
      - name: Extract tag name
        id: extract_tag
        run: |
          # ä» workflow_run ä¸­æå–æ ‡ç­¾åç§°
          TAG_NAME="${{ github.event.workflow_run.head_branch }}"
          echo "Raw tag: $TAG_NAME"
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=Release $TAG_NAME" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Download all build artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // è·å– workflow run çš„ artifacts
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            console.log(`Found ${artifacts.data.artifacts.length} artifacts`);

            // ä¸‹è½½æ¯ä¸ª artifact
            for (const artifact of artifacts.data.artifacts) {
              console.log(`Downloading artifact: ${artifact.name}`);
              
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
                archive_format: 'zip',
              });
              
              // åˆ›å»º artifacts ç›®å½•
              const artifactsDir = path.join(process.env.GITHUB_WORKSPACE, 'artifacts');
              if (!fs.existsSync(artifactsDir)) {
                fs.mkdirSync(artifactsDir, { recursive: true });
              }
              
              // ä¿å­˜å¹¶è§£å‹ artifact
              const zipPath = path.join(artifactsDir, `${artifact.name}.zip`);
              fs.writeFileSync(zipPath, Buffer.from(download.data));
              
              // è§£å‹åˆ°å¹³å°å‘½åçš„ç›®å½•
              const extractPath = path.join(artifactsDir, artifact.name);
              if (!fs.existsSync(extractPath)) {
                fs.mkdirSync(extractPath, { recursive: true });
              }
              
              // ä½¿ç”¨ unzip å‘½ä»¤è§£å‹
              const { execSync } = require('child_process');
              try {
                execSync(`cd "${artifactsDir}" && unzip -o "${artifact.name}.zip" -d "${artifact.name}"`);
                console.log(`Successfully extracted ${artifact.name}`);
              } catch (error) {
                console.error(`Failed to extract ${artifact.name}:`, error.message);
              }
            }

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la artifacts/
          echo ""
          echo "Content of each artifact:"
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "=== $(basename "$dir") ==="
              ls -la "$dir"
              echo ""
            fi
          done

      - name: Create npm directories
        run: |
          # åˆ›å»º npm ç›®å½•ç»“æ„ï¼Œå› ä¸º napi artifacts éœ€è¦è¿™äº›ç›®å½•å­˜åœ¨
          echo "Creating npm directory structure..."
          mkdir -p npm/{darwin-arm64,darwin-x64,linux-x64-gnu,linux-x64-musl,linux-arm64-gnu,linux-arm64-musl}
          echo "Created directories:"
          ls -la npm/

      - name: Debug GitHub access
        run: |
          echo "=== GitHub Token è¯Šæ–­ ==="
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Token available: ${GITHUB_TOKEN:+Yes}"
          echo "Testing GitHub API access..."

          # æµ‹è¯•åŸºæœ¬APIè®¿é—®
          if curl -s -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "https://api.github.com/repos/$GITHUB_REPOSITORY" > /tmp/repo_info.json; then
            echo "âœ… APIè®¿é—®æˆåŠŸ"
            echo "ä»“åº“æƒé™: $(jq -r '.permissions // "æ— æƒé™ä¿¡æ¯"' /tmp/repo_info.json)"
          else
            echo "âŒ APIè®¿é—®å¤±è´¥"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run napi prepublish
        run: |
          echo "Running napi prepublish..."
          if ! pnpm run prepublishOnly; then
            echo "âŒ napi prepublish failed (GitHub release 404), using fallback..."
            echo "Creating platform packages manually..."
            pnpm exec napi artifacts
            echo "âœ… Fallback completed"
          else
            echo "âœ… napi prepublish succeeded"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify npm packages
        run: |
          echo "Generated npm packages:"
          ls -la npm/
          echo "Platform packages with package.json:"
          find npm/ -name "package.json" -exec dirname {} \; | xargs -I {} basename {}

      - name: Collect .node files for release
        id: collect_nodes
        run: |
          echo "=== Collecting all .node files for GitHub Release ==="
          mkdir -p release_assets

          # å…ˆæŸ¥çœ‹ artifacts ç›®å½•ç»“æ„
          echo "Artifacts directory structure:"
          find artifacts/ -type f -name "*.node" || true

          # æŸ¥æ‰¾æ‰€æœ‰ .node æ–‡ä»¶å¹¶å¤åˆ¶åˆ° release_assets ç›®å½•
          node_files_found=0
          for node_file in $(find artifacts/ -name "*.node" -type f); do
            if [ -f "$node_file" ]; then
              filename=$(basename "$node_file")
              echo "ğŸ“¦ Found .node file: $filename"
              cp "$node_file" "release_assets/$filename"
              node_files_found=$((node_files_found + 1))
            fi
          done

          echo ""
          echo "=== Release Assets Summary ==="
          echo "Total .node files collected: $node_files_found"
          ls -la release_assets/ || echo "No files in release_assets/"

          if [ "$node_files_found" -eq 0 ]; then
            echo "âš ï¸  WARNING: No .node files found!"
            echo "Available files in artifacts:"
            find artifacts/ -type f | head -10
          fi

      - name: Create GitHub Release with .node files
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.extract_tag.outputs.tag_name }}
          name: ${{ steps.extract_tag.outputs.release_name }}
          body: |
            ## ğŸš€ bsdiff-rust ${{ steps.extract_tag.outputs.tag_name }}

            ### ğŸ“¦ Native Binaries
            This release includes precompiled native binaries for:
            - **macOS**: `bsdiff-rust.darwin-arm64.node`, `bsdiff-rust.darwin-x64.node`
            - **Linux**: `bsdiff-rust.linux-x64-gnu.node`, `bsdiff-rust.linux-x64-musl.node`, `bsdiff-rust.linux-arm64-gnu.node`, `bsdiff-rust.linux-arm64-musl.node`

            ### ğŸ“¥ Installation
            ```bash
            npm install bsdiff-rust@${{ steps.extract_tag.outputs.tag_name }}
            ```

            ### ğŸ¯ Direct Binary Download
            You can download individual platform binaries from the assets below.

            ### ğŸ”— Assets
            - **Source code**: Available as zip and tar.gz
            - **Native binaries**: Individual `.node` files for each platform

            *Generated by automated CI/CD pipeline* ğŸ¤–
          files: release_assets/*.node
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to npm
        # TODO: æ·»åŠ æ¡ä»¶ if: ${{ github.event_name == 'release' }} æ¥åªåœ¨ release æ—¶å‘å¸ƒ
        run: |
          echo "Event: ${{ github.event_name }}"

          # å‘å¸ƒä¸»åŒ…
          echo "Publishing main package..."
          pnpm publish --access public --no-git-checks

          # å‘å¸ƒå¹³å°å­åŒ…
          echo "Publishing platform packages..."
          for platform_dir in npm/*/; do
            if [ -f "$platform_dir/package.json" ]; then
              platform_name=$(basename "$platform_dir")
              echo "Publishing: $platform_name"
              (cd "$platform_dir" && npm publish --access public)
            fi
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
