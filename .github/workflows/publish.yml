name: Publish to npm

on:
  release:
    types: [published]
  workflow_run:
    workflows: ['Zig-Cross-Compile']
    types: [completed]
    branches: [main, master]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Download all build artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // 获取 workflow run 的 artifacts
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });

            console.log(`Found ${artifacts.data.artifacts.length} artifacts`);

            // 下载每个 artifact
            for (const artifact of artifacts.data.artifacts) {
              console.log(`Downloading artifact: ${artifact.name}`);
              
              const download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
                archive_format: 'zip',
              });
              
              // 创建 artifacts 目录
              const artifactsDir = path.join(process.env.GITHUB_WORKSPACE, 'artifacts');
              if (!fs.existsSync(artifactsDir)) {
                fs.mkdirSync(artifactsDir, { recursive: true });
              }
              
              // 保存并解压 artifact
              const zipPath = path.join(artifactsDir, `${artifact.name}.zip`);
              fs.writeFileSync(zipPath, Buffer.from(download.data));
              
              // 解压到平台命名的目录
              const extractPath = path.join(artifactsDir, artifact.name);
              if (!fs.existsSync(extractPath)) {
                fs.mkdirSync(extractPath, { recursive: true });
              }
              
              // 使用 unzip 命令解压
              const { execSync } = require('child_process');
              try {
                execSync(`cd "${artifactsDir}" && unzip -o "${artifact.name}.zip" -d "${artifact.name}"`);
                console.log(`Successfully extracted ${artifact.name}`);
              } catch (error) {
                console.error(`Failed to extract ${artifact.name}:`, error.message);
              }
            }

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -la artifacts/
          echo ""
          echo "Content of each artifact:"
          for dir in artifacts/*/; do
            if [ -d "$dir" ]; then
              echo "=== $(basename "$dir") ==="
              ls -la "$dir"
              echo ""
            fi
          done

      - name: Create npm directories
        run: |
          # 创建 npm 目录结构，因为 napi artifacts 需要这些目录存在
          echo "Creating npm directory structure..."
          mkdir -p npm/{darwin-arm64,darwin-x64,linux-x64-gnu,linux-x64-musl,linux-arm64-gnu,linux-arm64-musl}
          echo "Created directories:"
          ls -la npm/

      - name: Run napi artifacts
        run: |
          # 使用 napi artifacts 准备平台包
          echo "Running napi artifacts..."
          pnpm run prepublishOnly

      - name: Verify npm packages
        run: |
          echo "Checking generated npm packages:"
          ls -la npm/
          echo ""
          echo "Contents of each platform:"
          for dir in npm/*/; do
            if [ -d "$dir" ]; then
              echo "=== $(basename "$dir") ==="
              ls -la "$dir"
              echo ""
            fi
          done

      - name: Publish to npm
        run: |
          # 发布主包和平台包
          echo "Publishing packages..."

          # 如果是 release 事件，发布到 npm
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "Publishing release to npm..."
            pnpm publish --access public --no-git-checks
          else
            echo "Not a release event, skipping npm publish"
            echo "Event: ${{ github.event_name }}"
            # TODO: 测试发布
            pnpm publish --access public --no-git-checks
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
