# 🚀 bsdiff-rust 基准测试

## 📋 概述

本文档描述了 `bsdiff-rust` 项目的基准测试方法和结果。基准测试用于评估库的性能表现，包括处理速度、内存使用和压缩效率。

## 🧪 基准测试类型

### 1. **JavaScript 基准测试** (`benchmark/benchmark.ts`)

测试 Node.js 绑定的性能，包括：

- 不同文件大小的处理性能
- 不同变化比例的压缩效率
- 工具方法的执行速度

### 2. **Rust 基准测试** (`benchmark/benchmark.rs`)

测试 Rust 核心功能的性能，包括：

- 文件 I/O 性能
- 数据生成和处理速度
- 内存分配效率
- 字符串操作性能

## 🚀 运行基准测试

### JavaScript 基准测试

```bash
# 运行完整的 JavaScript 基准测试
npm run bench

# 或者直接运行
node --import @oxc-node/core/register benchmark/benchmark.ts
```

### Rust 基准测试

```bash
# 运行 Rust 基准测试
npm run bench:rust

# 或者直接运行
cargo bench
```

## 📊 基准测试内容

### 1. **文件大小测试**

测试不同大小文件的处理性能：

| 文件大小 | 描述     | 预期性能 |
| -------- | -------- | -------- |
| 1KB      | 小文件   | < 10ms   |
| 10KB     | 中小文件 | < 50ms   |
| 100KB    | 中等文件 | < 200ms  |
| 1MB      | 大文件   | < 1s     |
| 5MB      | 超大文件 | < 5s     |

### 2. **变化比例测试**

测试不同变化比例对性能的影响：

| 变化比例 | 描述     | 压缩效率   |
| -------- | -------- | ---------- |
| 1%       | 微小变化 | 高压缩比   |
| 5%       | 小变化   | 中等压缩比 |
| 10%      | 中等变化 | 标准压缩比 |
| 20%      | 大变化   | 较低压缩比 |
| 50%      | 巨大变化 | 低压缩比   |

### 3. **工具方法测试**

测试各种工具方法的性能：

- `verify_patch` - 补丁验证
- `get_patch_info` - 获取补丁信息
- `get_compression_ratio` - 计算压缩比
- `get_file_size` - 获取文件大小
- `check_file_access` - 检查文件访问权限

## 📈 性能指标

### 1. **处理速度**

- **平均时间**: 多次运行的平均耗时
- **最短时间**: 最佳性能表现
- **最长时间**: 最差性能表现

### 2. **压缩效率**

- **压缩比**: 补丁文件相对于原始文件的大小比例
- **压缩率**: 节省的存储空间百分比

### 3. **内存使用**

- **峰值内存**: 处理过程中的最大内存使用量
- **内存效率**: 每 MB 数据的内存使用量

## 🔍 基准测试结果示例

### JavaScript 基准测试输出

```
🚀 bsdiff-rust 性能基准测试
==================================================

📏 测试不同文件大小

🧪 运行基准测试: 文件大小 1KB
   迭代次数: 5
   1/5 - 2.34ms (0.85 KB)
   2/5 - 2.12ms (0.85 KB)
   3/5 - 2.45ms (0.85 KB)
   4/5 - 2.18ms (0.85 KB)
   5/5 - 2.31ms (0.85 KB)

📊 结果统计:
   平均时间: 2.28ms
   最短时间: 2.12ms
   最长时间: 2.45ms
   平均大小: 0.85 KB

📊 测试不同变化比例

🧪 运行基准测试: 变化比例 10%
   迭代次数: 5
   1/5 - 156.78ms (785.36 KB)
   2/5 - 148.92ms (785.36 KB)
   3/5 - 162.34ms (785.36 KB)
   4/5 - 151.67ms (785.36 KB)
   5/5 - 158.91ms (785.36 KB)

📊 结果统计:
   平均时间: 155.72ms
   最短时间: 148.92ms
   最长时间: 162.34ms
   平均大小: 785.36 KB

🔧 测试工具方法性能

🧪 运行基准测试: verify_patch
   迭代次数: 5
   1/5 - 89.45ms
   2/5 - 87.23ms
   3/5 - 91.67ms
   4/5 - 88.12ms
   5/5 - 90.34ms

📊 结果统计:
   平均时间: 89.36ms
   最短时间: 87.23ms
   最长时间: 91.67ms

📋 性能测试总结
==================================================

📏 文件大小测试结果:
   1KB: 平均 2.28ms
   10KB: 平均 8.45ms
   100KB: 平均 45.67ms
   1MB: 平均 156.78ms
   5MB: 平均 892.34ms

📊 变化比例测试结果:
   1%: 平均 89.23ms
   5%: 平均 123.45ms
   10%: 平均 155.72ms
   20%: 平均 234.56ms
   50%: 平均 567.89ms

🔧 工具方法测试结果:
   verify_patch: 平均 89.36ms
   get_patch_info: 平均 0.12ms
   get_compression_ratio: 平均 0.23ms
   get_file_size: 平均 0.05ms
   check_file_access: 平均 0.03ms

✅ 基准测试完成！
```

### Rust 基准测试输出

```
File I/O Performance/write_1KB
                        time:   [1.2345 ms 1.2567 ms 1.2789 ms]
                        thrpt:  [781.25 MiB/s 795.45 MiB/s 810.00 MiB/s]

File I/O Performance/read_1KB
                        time:   [0.5678 ms 0.5789 ms 0.5901 ms]
                        thrpt:  [1.692 GiB/s 1.726 GiB/s 1.761 GiB/s]

Data Generation/generate_1MB
                        time:   [2.3456 ms 2.3789 ms 2.4123 ms]

Memory Allocation/allocate_10MB
                        time:   [12.3456 ms 12.4567 ms 12.5678 ms]
```

## 📊 性能基准

### 1. **处理速度基准**

| 文件大小 | 优秀    | 良好    | 一般    | 需要优化 |
| -------- | ------- | ------- | ------- | -------- |
| 1KB      | < 5ms   | < 10ms  | < 20ms  | > 20ms   |
| 10KB     | < 20ms  | < 50ms  | < 100ms | > 100ms  |
| 100KB    | < 100ms | < 200ms | < 500ms | > 500ms  |
| 1MB      | < 500ms | < 1s    | < 2s    | > 2s     |
| 5MB      | < 2s    | < 5s    | < 10s   | > 10s    |

### 2. **压缩效率基准**

| 变化比例 | 优秀压缩比 | 良好压缩比 | 一般压缩比 |
| -------- | ---------- | ---------- | ---------- |
| 1%       | < 5%       | < 10%      | < 20%      |
| 5%       | < 15%      | < 25%      | < 40%      |
| 10%      | < 25%      | < 40%      | < 60%      |
| 20%      | < 40%      | < 60%      | < 80%      |
| 50%      | < 60%      | < 80%      | < 90%      |

### 3. **工具方法基准**

| 方法                  | 优秀    | 良好    | 一般    |
| --------------------- | ------- | ------- | ------- |
| verify_patch          | < 100ms | < 200ms | < 500ms |
| get_patch_info        | < 1ms   | < 5ms   | < 10ms  |
| get_compression_ratio | < 1ms   | < 5ms   | < 10ms  |
| get_file_size         | < 0.1ms | < 0.5ms | < 1ms   |
| check_file_access     | < 0.1ms | < 0.5ms | < 1ms   |

## 🔧 性能优化建议

### 1. **如果处理速度慢**

- 检查文件 I/O 是否使用了缓冲
- 考虑使用异步处理
- 优化内存分配策略

### 2. **如果压缩效率低**

- 检查数据变化模式
- 考虑使用不同的压缩算法
- 优化 bsdiff 算法参数

### 3. **如果内存使用高**

- 使用流式处理
- 优化缓冲区大小
- 及时释放不需要的内存

## 📝 基准测试最佳实践

### 1. **测试环境**

- 使用相同的硬件配置
- 关闭其他应用程序
- 多次运行取平均值

### 2. **测试数据**

- 使用真实的文件数据
- 包含多种变化模式
- 覆盖不同的文件大小

### 3. **结果分析**

- 关注趋势而非绝对值
- 比较相对性能
- 考虑实际使用场景

## 🚀 持续性能监控

建议定期运行基准测试来监控性能变化：

```bash
# 每周运行一次基准测试
npm run bench > benchmark-results-$(date +%Y%m%d).log

# 比较不同版本的结果
diff benchmark-results-20231201.log benchmark-results-20231208.log
```

这样可以及时发现性能回归问题，确保库的性能持续优化。
